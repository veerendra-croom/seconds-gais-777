
# User Roles & Permissions Guide

**Seconds-App** is designed with a strict role-based access control (RBAC) system. The platform distinguishes between two primary user types: **Students** (the core user base) and **Admins** (platform managers).

## 1. Student Role

The Student role is the default for all users who sign up with a university affiliation. The experience is designed to be safe, verified, and community-focused.

### A. Onboarding & Verification
1.  **Registration**: Students sign up using their personal email initially.
2.  **College Link**: To unlock marketplace features, they must link a valid `.edu` email address.
3.  **ID Verification**:
    *   Students upload a photo of their physical Student ID card.
    *   **Status**: `NONE` -> `PENDING` -> `VERIFIED` (or `REJECTED`).
    *   **Privileges**: Unverified users have "Read Only" access (can browse but not chat or buy). Verified users have full access.

### B. Core Capabilities
*   **Buying**:
    *   Browse items securely within their college geolocation.
    *   Initiate transactions via Stripe (simulated escrow).
    *   Generate a QR code for secure meetup verification.
*   **Selling**:
    *   List items using AI-assisted tools (image recognition, price suggestion).
    *   Manage inventory (mark as sold, delete).
    *   Scan QR codes to confirm item handover and release funds.
*   **Communication**:
    *   1:1 Chat with other students.
    *   Send smart replies generated by Gemini AI.
    *   Propose meetups in safe zones.
*   **Wallet**:
    *   Track earnings in an internal ledger.
    *   Withdraw funds to a bank account (simulated payout).

### C. Safety Features
*   **SOS Alert**: Trigger an emergency email to trusted contacts.
*   **Reporting**: Flag suspicious items or users to Admins.
*   **Blocking**: Block users to prevent them from messaging or seeing listings.

### D. Data Access (RLS Policies)
*   **Read**: Can read all `ACTIVE` items and public profiles.
*   **Write**: Can only update their own `profile` and `items`.
*   **Private**: Can only access `transactions` and `messages` where they are a participant (`sender_id`, `receiver_id`, `buyer_id`, or `seller_id`).

---

## 2. Admin Role

The Admin role provides oversight and management capabilities. Admins are responsible for maintaining trust and safety on the platform.

### A. Access Control
*   **Creation**: Admin accounts are created during sign-up by entering a specific **Admin Access Code** (e.g., `SECONDS2024`) defined in the `app_config` table.
*   **Security**: Admin privileges are enforced via Row Level Security (RLS) policies in the database.

### B. Dashboard Capabilities
The Admin Dashboard (`views/AdminDashboard.tsx`) serves as the command center:

1.  **User Management**:
    *   **View All Users**: Searchable list of all registered profiles.
    *   **Deep Dive**: Inspect user transaction history, chat logs (if necessary for safety), and report history.
    *   **Ban/Unban**: Revoke access for bad actors immediately.
2.  **Verification Queue**:
    *   Review pending Student ID uploads.
    *   Approve or Reject verification requests with a single click.
3.  **Financial Oversight**:
    *   View all transactions platform-wide.
    *   **Intervention**: Ability to force-release funds to a seller or force-refund a buyer in case of disputes.
4.  **Content Moderation**:
    *   Review user reports regarding items or behavior.
    *   Dismiss reports or delete offending items directly.
5.  **System Configuration**:
    *   Toggle **Maintenance Mode** (locks out students).
    *   Update **Platform Fees**.
    *   Set **Global Banners** for announcements.
    *   Enable/Disable specific modules (e.g., turn off 'Rentals' temporarily).
6.  **Broadcasts**:
    *   Send system-wide push notifications to all users.

### C. Data Access (RLS Policies)
*   **Read**: Full read access to `profiles`, `items`, `transactions`, `reports`, `verification_codes`, and `app_config`.
*   **Write**: Can update specific fields (e.g., `banned` status, `verified` status) and sensitive configuration tables.

---

## 3. Permissions Matrix

| Feature / Action | Unverified Student | Verified Student | Admin |
| :--- | :---: | :---: | :---: |
| **Browse Items** | ✅ | ✅ | ✅ |
| **View Profiles** | ✅ | ✅ | ✅ |
| **List Items** | ❌ | ✅ | ✅ (Test) |
| **Buy / Chat** | ❌ | ✅ | ❌ |
| **Upload ID** | ✅ | ❌ | N/A |
| **Withdraw Funds** | ❌ | ✅ | N/A |
| **Ban Users** | ❌ | ❌ | ✅ |
| **Verify IDs** | ❌ | ❌ | ✅ |
| **Resolve Reports**| ❌ | ❌ | ✅ |
| **Edit Config** | ❌ | ❌ | ✅ |
| **View Audit Logs**| ❌ | ❌ | ✅ |

---

## 4. Technical Implementation Details

### Row Level Security (RLS)
Security is handled at the database level using PostgreSQL policies.

**Example: Admin Access Policy**
```sql
create policy "Admins can view all profiles"
  on public.profiles
  for select
  using (
    exists (
      select 1 from public.profiles
      where id = auth.uid() and role = 'ADMIN'
    )
  );
```

### Admin Code Verification
The admin signup process is protected by a server-side check against the `app_config` table.
*   **Client**: Sends code during registration.
*   **Server**: Checks `select value from app_config where key = 'admin_signup_code'`.
*   If valid, the user is inserted with `role = 'ADMIN'`.
